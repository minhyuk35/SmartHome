<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Smart Home Control</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f5f7fb; margin: 0; padding: 0; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        h1 { margin: 0 0 10px; }
        .card { background: #fff; border-radius: 12px; padding: 16px; margin-bottom: 16px;
                box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; }
        .btn { padding: 10px 12px; border: none; border-radius: 8px; cursor: pointer;
               color: #fff; font-weight: 600; transition: transform .08s ease, box-shadow .08s ease, opacity .12s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.12); opacity: 0.95; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .primary { background: #3182f6; }
        .danger { background: #d64545; }
        .neutral { background: #a0aec0; }
        .accent { background: #ff64c7; }
        .success { background: #20a05c; }
        .log { height: 160px; overflow-y: auto; background: #0f172a; color: #d1e0ff;
               font-family: Consolas, monospace; font-size: 12px; padding: 10px; border-radius: 8px; }
        label { font-weight: 600; }
        input[type=range] { width: 100%; }
        .sensor { font-size: 14px; color: #1f2937; }
        .sensor span { display: block; }
        .auth-banner { display: none; background: #fff7ed; border: 1px solid #fdba74; color: #b45309;
                       border-radius: 10px; padding: 12px; margin-bottom: 12px; }
    </style>
</head>
<body>
<div class="container">
    <h1>Smart Home Web Control</h1>
    <p>Python 연동 그대로, 웹소켓으로 제어/모니터링.</p>

    <div id="authBanner" class="auth-banner">
        PIR 감지됨! 인증 중입니다. 얼굴을 보여주세요. (TTS 안내 송출)
    </div>

    <div class="card">
        <h3>센서</h3>
        <div class="grid sensor" id="sensorBox">
            <div><label>Gas</label><span id="gasVal">-</span></div>
            <div><label>Temp</label><span id="tempVal">-</span></div>
            <div><label>Dust</label><span id="dustVal">-</span></div>
            <div><label>PIR</label><span id="pirVal">-</span></div>
        </div>
    </div>

    <div class="card">
        <h3>조명/가전</h3>
        <div class="grid">
            <button class="btn primary control" onclick="sendCmd('LED_ON')">LED ON</button>
            <button class="btn neutral control" onclick="sendCmd('LED_OFF')">LED OFF</button>
            <button class="btn primary control" onclick="sendCmd('FAN_ON')">FAN ON</button>
            <button class="btn neutral control" onclick="sendCmd('FAN_OFF')">FAN OFF</button>
            <button class="btn primary control" onclick="sendCmd('LIGHT_SLEEP')">SLEEP MODE</button>
            <button class="btn primary control" onclick="sendCmd('LIGHT_WARM')">WARM MODE</button>
            <button class="btn accent control" onclick="sendCmd('RGB_ON')">RGB ON</button>
            <button class="btn neutral control" onclick="sendCmd('RGB_OFF')">RGB OFF</button>
        </div>
    </div>

    <div class="card">
        <h3>RGB 값</h3>
        <div class="grid">
            <div>
                <label>R</label>
                <input type="range" id="rVal" min="0" max="100" value="0">
            </div>
            <div>
                <label>G</label>
                <input type="range" id="gVal" min="0" max="100" value="0">
            </div>
            <div>
                <label>B</label>
                <input type="range" id="bVal" min="0" max="100" value="0">
            </div>
        </div>
        <button class="btn primary control" style="margin-top: 10px;" onclick="sendRgb()">RGB 적용</button>
    </div>

    <div class="card">
        <h3>얼굴/음성</h3>
        <div class="grid">
            <button class="btn success" onclick="sendCmd('REQ_FACE_UNLOCK')">얼굴로 열기</button>
            <button class="btn neutral" onclick="sendCmd('REGISTER_FACE')">얼굴 등록</button>
            <button id="voiceBtn" class="btn primary control" onclick="toggleVoice()">음성 시작</button>
        </div>
    </div>

    <div class="card">
        <h3>로그</h3>
        <div class="log" id="log"></div>
    </div>
</div>

<script>
    const ws = new WebSocket(`ws://${location.host}/ws`);

    ws.onopen = () => appendLog('ws', 'connected');
    ws.onclose = () => appendLog('ws', 'disconnected');
    ws.onerror = (e) => appendLog('ws', 'error: ' + e.message);
    ws.onmessage = (msg) => {
        try {
            const data = JSON.parse(msg.data);
            if (data.type === 'sensor' && data.payload) {
                const p = data.payload;
                document.getElementById('gasVal').innerText = p.gas ?? '-';
                document.getElementById('tempVal').innerText = p.temp ?? '-';
                document.getElementById('dustVal').innerText = p.dust ?? '-';
                document.getElementById('pirVal').innerText = (p.pir === 1 ? 'Motion' : 'No Motion');
                handlePir(p.pir);
            } else if (data.type === 'from_python') {
                handlePythonMessage(data.payload);
            } else if (data.type === 'door_event') {
                handleDoorEvent(data.payload);
            } else {
                appendLog(data.type || 'msg', JSON.stringify(data.payload ?? data));
            }
        } catch (err) {
            appendLog('err', msg.data);
        }
    };

    function send(payload) {
        ws.send(JSON.stringify(payload));
    }

    function sendCmd(cmd) {
        send({type: 'command', command: cmd});
    }

    function sendRgb() {
        const r = document.getElementById('rVal').value;
        const g = document.getElementById('gVal').value;
        const b = document.getElementById('bVal').value;
        send({type: 'rgb', r, g, b});
    }

    let voiceOn = false;
    let authorized = false;

    disableControls(true);

    function toggleVoice() {
        if (!authorized) { appendLog('auth', '먼저 인증이 필요합니다'); return; }
        voiceOn = !voiceOn;
        if (voiceOn) {
            send({type: 'voice', action: 'start'});
            setVoiceBtn(true);
        } else {
            send({type: 'voice', action: 'stop'});
            setVoiceBtn(false);
        }
    }

    function setVoiceBtn(isOn) {
        const btn = document.getElementById('voiceBtn');
        if (!btn) return;
        if (isOn) {
            btn.className = 'btn danger';
            btn.textContent = '음성 정지';
        } else {
            btn.className = 'btn primary';
            btn.textContent = '음성 시작';
        }
    }

    function disableControls(flag) {
        document.querySelectorAll('.control').forEach(btn => btn.disabled = flag);
    }

    function showAuth() {
        const banner = document.getElementById('authBanner');
        banner.style.display = 'block';
        disableControls(true);
    }

    function hideAuth() {
        const banner = document.getElementById('authBanner');
        banner.style.display = 'none';
        disableControls(false);
    }

    function authorize(reason) {
        authorized = true;
        hideAuth();
        appendLog('auth', `인증됨: ${reason}`);
    }

    function handlePythonMessage(msg) {
        const text = (msg || '').toUpperCase();
        appendLog('from_python', msg);
        if (text.includes('UNLOCK')) {
            authorize('얼굴 인식/키패드');
        }
    }

    function handleDoorEvent(evt) {
        const text = (evt || '').toUpperCase();
        appendLog('door', evt);
        if (text.includes('UNLOCK')) {
            authorize('키패드/도어락');
        }
    }

    function triggerAuthFlow() {
        // 얼굴 인식 요청 + PC TTS 안내(PROMPT_AUTH는 python main.py에서 처리)
        sendCmd('PROMPT_AUTH');
        sendCmd('REQ_FACE_UNLOCK');
    }

    let lastPirTime = 0;
    const PIR_COOLDOWN_MS = 5000;
    function handlePir(pirVal) {
        if (pirVal !== 1) return;
        if (authorized) return; // 이미 인증되었으면 재요청 안 함
        const now = Date.now();
        if (now - lastPirTime < PIR_COOLDOWN_MS) return;
        lastPirTime = now;
        showAuth();
        triggerAuthFlow();
    }

    function appendLog(tag, text) {
        const box = document.getElementById('log');
        const line = `[${new Date().toLocaleTimeString()}] ${tag}: ${text}\n`;
        box.textContent = (line + box.textContent).slice(0, 8000);
    }
</script>
</body>
</html>
